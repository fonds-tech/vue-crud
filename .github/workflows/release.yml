name: Release

on:
  push:
    tags:
      - 'v*'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      dry_run:
        description: æ˜¯å¦ä¸ºæ¨¡æ‹Ÿè¿è¡Œï¼ˆä¸å®žé™…å‘å¸ƒï¼‰
        required: false
        default: false
        type: boolean

# å¹¶å‘æŽ§åˆ¶ï¼šåŒä¸€åˆ†æ”¯åªå…è®¸ä¸€ä¸ªå‘å¸ƒæµç¨‹è¿è¡Œ
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: 'lts/*'
  PNPM_VERSION: '10'

jobs:
  # ==================== é¢„æ£€æŸ¥ ====================
  preflight:
    name: ðŸ” é¢„æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æå–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#v}"
          else
            VERSION=$(node -p "require('./package.json').version")
            TAG="v${VERSION}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ å‡†å¤‡å‘å¸ƒç‰ˆæœ¬: ${VERSION} (æ ‡ç­¾: ${TAG})"

  # ==================== ä»£ç è´¨é‡æ£€æŸ¥ ====================
  lint:
    name: ðŸ”¬ ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: preflight
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: é…ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ä»£ç æ£€æŸ¥
        run: pnpm run lint

      - name: ç±»åž‹æ£€æŸ¥
        run: pnpm run typecheck

  # ==================== æµ‹è¯• ====================
  test:
    name: ðŸ§ª æµ‹è¯•
    runs-on: ubuntu-latest
    needs: preflight
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: é…ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œæµ‹è¯•
        run: pnpm run test -- --run

  # ==================== æž„å»º ====================
  build:
    name: ðŸ—ï¸ æž„å»º
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: é…ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æž„å»ºåº“
        run: pnpm run build

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  # ==================== å‘å¸ƒåˆ° NPM ====================
  publish-npm:
    name: ðŸ“¦ å‘å¸ƒåˆ° NPM
    runs-on: ubuntu-latest
    needs: [preflight, build]
    if: ${{ !inputs.dry_run }}
    permissions:
      contents: read
      id-token: write # ç”¨äºŽ npm provenance
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: é…ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: pnpm

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: å‘å¸ƒåˆ° NPM
        run: pnpm publish --access public --no-git-checks --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ==================== åˆ›å»º GitHub Release ====================
  github-release:
    name: ðŸš€ åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    needs: [preflight, publish-npm]
    if: ${{ !inputs.dry_run }}
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # èŽ·å–å®Œæ•´åŽ†å²ä»¥ç”Ÿæˆå˜æ›´æ—¥å¿—

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "ðŸ“ è¿™æ˜¯é¦–æ¬¡å‘å¸ƒï¼Œåˆ—å‡ºæ‰€æœ‰æäº¤"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "ðŸ“ ç”Ÿæˆè‡ª ${PREVIOUS_TAG} ä»¥æ¥çš„å˜æ›´æ—¥å¿—"
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # å°†å˜æ›´æ—¥å¿—å†™å…¥æ–‡ä»¶ï¼ˆå¤„ç†å¤šè¡Œï¼‰
          echo "$CHANGELOG" > changelog.md

          echo "changelog_file=changelog.md" >> $GITHUB_OUTPUT

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.preflight.outputs.tag }}
          name: ${{ needs.preflight.outputs.tag }}
          body_path: changelog.md
          draft: false
          prerelease: ${{ contains(needs.preflight.outputs.version, '-') }}
          files: |
            dist/**/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================== éƒ¨ç½²æ–‡æ¡£ï¼ˆå¯é€‰ï¼‰ ====================
  deploy-docs:
    name: ðŸ“š éƒ¨ç½²æ–‡æ¡£
    runs-on: ubuntu-latest
    needs: [preflight, build]
    if: ${{ !inputs.dry_run && startsWith(github.ref, 'refs/tags/v') }}
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: é…ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æž„å»ºæ–‡æ¡£
        run: pnpm run docs:build

      - name: é…ç½® Pages
        uses: actions/configure-pages@v5

      - name: ä¸Šä¼ åˆ° Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist

      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ==================== å‘å¸ƒé€šçŸ¥ï¼ˆå¯é€‰ï¼‰ ====================
  notify:
    name: ðŸ“£ å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [preflight, github-release]
    if: ${{ always() && !inputs.dry_run }}
    steps:
      - name: å‘å¸ƒç»“æžœæ±‡æ€»
        run: |
          echo "## ðŸ“¦ å‘å¸ƒç»“æžœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | ${{ needs.preflight.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ ‡ç­¾ | ${{ needs.preflight.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM | [vue-crud@${{ needs.preflight.outputs.version }}](https://www.npmjs.com/package/vue-crud) |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | [${{ needs.preflight.outputs.tag }}](https://github.com/${{ github.repository }}/releases/tag/${{ needs.preflight.outputs.tag }}) |" >> $GITHUB_STEP_SUMMARY
